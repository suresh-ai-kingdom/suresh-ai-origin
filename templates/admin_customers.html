{% extends "_admin_header.html" %}

{% block title %}Customer Intelligence{% endblock %}

{% block content %}
<div class="customers-container">
    <div class="page-header">
        <h1>üë• Customer Intelligence</h1>
        <p class="subtitle">Segment customers by behavior, track LTV, identify growth opportunities</p>
    </div>

    <!-- Segment Overview -->
    <div class="segments-overview">
        <h2>Customer Segments</h2>
        <div class="segment-cards">
            {% for segment, stats in segments.items() %}
            <div class="segment-card">
                <div class="segment-icon">
                    {% if segment == 'VIP' %}üíé
                    {% elif segment == 'LOYAL' %}‚≠ê
                    {% elif segment == 'GROWING' %}üìà
                    {% elif segment == 'AT_RISK' %}‚ö†Ô∏è
                    {% elif segment == 'NEW' %}‚ú®
                    {% elif segment == 'ONE_TIME' %}üë§
                    {% elif segment == 'DORMANT' %}üò¥
                    {% elif segment == 'CHURNED' %}‚ùå
                    {% endif %}
                </div>
                <div class="segment-name">{{ segment }}</div>
                <div class="segment-count">{{ stats.customer_count }} customers</div>
                <div class="segment-percentage">{{ stats.percentage }}% of base</div>
                <div class="segment-ltv">‚Çπ{{ (stats.total_ltv_paise / 100)|int }}</div>
                <div class="segment-label">Total LTV</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Churn Risk & Opportunities -->
    <div class="risk-opportunities">
        <!-- Churn Risk -->
        <div class="risk-section">
            <h2>‚ö†Ô∏è Churn Risk Alert</h2>
            {% if churn_risk %}
            <div class="churn-list">
                {% for customer in churn_risk %}
                <div class="churn-item risk-{{ customer.urgency.lower() }}">
                    <div class="churn-info">
                        <div class="churn-receipt">{{ customer.receipt[-8:] }}</div>
                        <div class="churn-details">
                            <span class="segment-badge">{{ customer.segment }}</span>
                            <span class="inactive">{{ customer.days_inactive }}d inactive</span>
                        </div>
                    </div>
                    <div class="churn-value">
                        <div class="ltv">‚Çπ{{ (customer.ltv_paise / 100)|int }}</div>
                        <div class="urgency urgency-{{ customer.urgency.lower() }}">{{ customer.urgency }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-data">No customers at risk üéâ</p>
            {% endif %}
        </div>

        <!-- Marketing Opportunities -->
        <div class="opportunities-section">
            <h2>üéØ Marketing Opportunities</h2>
            <div class="opportunities-grid">
                {% for segment, opp in opportunities.items() %}
                <div class="opportunity-card">
                    <div class="opp-title">{{ opp.action }}</div>
                    <div class="opp-desc">{{ opp.description }}</div>
                    <div class="opp-impact">{{ opp.potential_impact }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Top Customers by LTV -->
    <div class="customers-section">
        <h2>üí∞ Top Customers by LTV</h2>
        <table class="customers-table">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Segment</th>
                    <th>Lifetime Value</th>
                    <th>Orders</th>
                    <th>Avg Order</th>
                    <th>Last Purchase</th>
                    <th>Customer Age</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers[:20] %}
                <tr class="segment-{{ customer.segment.lower().replace(' ', '-') }}">
                    <td>{{ customer.receipt[-6:] }}</td>
                    <td><span class="segment-badge">{{ customer.segment }}</span></td>
                    <td class="ltv-value">‚Çπ{{ (customer.ltv_paise / 100)|int }}</td>
                    <td class="center">{{ customer.order_count }}</td>
                    <td class="center">‚Çπ{{ (customer.avg_order_value_paise / 100)|int }}</td>
                    <td class="center">{{ customer.days_since_purchase }}d</td>
                    <td class="center">{{ customer.customer_age_days }}d</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if customers|length > 20 %}
        <p class="table-note">Showing top 20 of {{ customers|length }} customers</p>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
async function loadSegmentChart() {
    const response = await fetch('/api/customers/by-segment');
    const segments = await response.json();
    
    const labels = Object.keys(segments);
    const counts = labels.map(s => segments[s].customer_count);
    const colors = {
        'VIP': '#6366f1',
        'LOYAL': '#8b5cf6',
        'GROWING': '#10b981',
        'AT_RISK': '#f59e0b',
        'NEW': '#3b82f6',
        'ONE_TIME': '#6b7280',
        'DORMANT': '#9ca3af',
        'CHURNED': '#ef4444'
    };
    
    const ctx = document.querySelector('.segment-chart')?.getContext('2d');
    if (ctx) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: labels.map(l => colors[l] || '#999')
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', loadSegmentChart);
</script>

<style>
.customers-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    margin-bottom: 30px;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 15px;
}

.page-header h1 {
    margin: 0 0 5px;
    font-size: 2em;
    color: #1f2937;
}

.subtitle {
    margin: 0;
    color: #6b7280;
    font-size: 0.95em;
}

.segments-overview {
    margin-bottom: 40px;
}

.segments-overview h2 {
    font-size: 1.3em;
    color: #1f2937;
    margin-bottom: 20px;
}

.segment-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
}

.segment-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.segment-card:hover {
    border-color: #6366f1;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
}

.segment-icon {
    font-size: 2em;
    margin-bottom: 8px;
}

.segment-name {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 5px;
}

.segment-count {
    font-size: 0.9em;
    color: #6b7280;
    margin-bottom: 10px;
}

.segment-percentage {
    font-size: 0.85em;
    color: #9ca3af;
    margin-bottom: 10px;
}

.segment-ltv {
    font-size: 1.4em;
    font-weight: bold;
    color: #6366f1;
}

.segment-label {
    font-size: 0.8em;
    color: #9ca3af;
}

.risk-opportunities {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 40px;
}

.risk-section, .opportunities-section {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.risk-section h2, .opportunities-section h2 {
    margin-top: 0;
    color: #1f2937;
    font-size: 1.2em;
}

.churn-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.churn-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f9fafb;
    border-left: 4px solid #f59e0b;
    border-radius: 6px;
}

.churn-item.risk-critical {
    border-left-color: #ef4444;
    background: #fef2f2;
}

.churn-item.risk-high {
    border-left-color: #f59e0b;
    background: #fffbeb;
}

.churn-info {
    flex: 1;
}

.churn-receipt {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.85em;
}

.churn-details {
    display: flex;
    gap: 8px;
    margin-top: 5px;
    font-size: 0.8em;
}

.segment-badge {
    display: inline-block;
    background: #e0e7ff;
    color: #4338ca;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 500;
}

.inactive {
    color: #6b7280;
}

.churn-value {
    text-align: right;
}

.ltv {
    font-weight: bold;
    color: #1f2937;
}

.urgency {
    font-size: 0.75em;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 3px;
    margin-top: 3px;
    display: inline-block;
}

.urgency-critical {
    background: #fee2e2;
    color: #991b1b;
}

.urgency-high {
    background: #fef3c7;
    color: #92400e;
}

.urgency-medium {
    background: #dbeafe;
    color: #0c4a6e;
}

.opportunities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
}

.opportunity-card {
    padding: 12px;
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 6px;
}

.opp-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 5px;
    font-size: 0.9em;
}

.opp-desc {
    font-size: 0.8em;
    color: #4b5563;
    margin-bottom: 8px;
}

.opp-impact {
    font-size: 0.75em;
    color: #0c4a6e;
    font-weight: 500;
}

.customers-section {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    overflow-x: auto;
}

.customers-section h2 {
    margin-top: 0;
    color: #1f2937;
}

.customers-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}

.customers-table thead {
    background: #f3f4f6;
}

.customers-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #1f2937;
    border-bottom: 2px solid #d1d5db;
    font-size: 0.9em;
}

.customers-table td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.9em;
}

.customers-table tbody tr:hover {
    background: #f9fafb;
}

.ltv-value {
    font-weight: 600;
    color: #6366f1;
}

.center {
    text-align: center;
}

.table-note {
    color: #6b7280;
    font-size: 0.9em;
    margin: 0;
}

.no-data {
    color: #6b7280;
    text-align: center;
    padding: 20px;
}

@media (max-width: 768px) {
    .segment-cards {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .risk-opportunities {
        grid-template-columns: 1fr;
    }
    
    .customers-table {
        font-size: 0.85em;
    }
    
    .customers-table th, .customers-table td {
        padding: 8px;
    }
}
</style>
{% endblock %}
