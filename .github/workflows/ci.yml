name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, 3.12]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Production cookie enforcement check
        env:
          FLASK_DEBUG: 'False'
        run: |
          python - <<'PY'
          import sys
          import importlib
          # Import app in a fresh Python process with FLASK_DEBUG=false
          app = importlib.import_module('app')
          importlib.reload(app)
          cfg = app.app.config
          if not cfg.get('SESSION_COOKIE_SECURE', False):
              print("ERROR: SESSION_COOKIE_SECURE is False when FLASK_DEBUG is False. Default must be secure.")
              sys.exit(1)
          print("Production cookie config OK: SESSION_COOKIE_SECURE =", cfg.get('SESSION_COOKIE_SECURE'))
          PY

      - name: Run migrations (safe for SQLite)
        run: |
          set -e
          # Ensure the project root is importable for alembic env
          export PYTHONPATH=.
          alembic upgrade head || alembic stamp head
      - name: Run tests
        run: pytest -q

  prod-warning-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt
      - name: Check that insecure cookie logs warning in production
        env:
          FLASK_DEBUG: 'False'
          SESSION_COOKIE_SECURE: 'False'
        run: |
          set -e
          python - <<'PY' 2>&1 | tee /tmp/prod_warning_out.txt
          import importlib
          import importlib.util
          importlib.reload(importlib.import_module('app'))
          PY
          grep -i "insecure" /tmp/prod_warning_out.txt || (echo "Expected startup warning not found" && exit 1)

